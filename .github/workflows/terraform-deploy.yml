name: Terraform Deployment

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      debug_logs:
        description: 'Enable debug logging for Terraform'
        required: false
        default: false
        type: boolean

env:
  TERRAFORM_VERSION: '1.5.0'
  WORKING_DIR: '.'

jobs:
  terraform-deploy:
    name: 'Terraform Plan and Apply'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Set Environment Variables
        run: |
          echo "Setting up all required environment variables..."
          
          echo "ARM_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=${{ secrets.AZURE_CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}" >> $GITHUB_ENV
      
          echo "TF_VAR_databricks_account_id=${{ secrets.DATABRICKS_ACCOUNT_ID }}" >> $GITHUB_ENV
          echo "TF_VAR_databricks_account_host=https://accounts.azuredatabricks.net" >> $GITHUB_ENV
          
          echo "TF_VAR_databricks_workspace_host=" >> $GITHUB_ENV
        
      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        env:
          TF_LOG: ${{ github.event.inputs.debug_logs == 'true' && 'DEBUG' || '' }}
        run: |
          if [ "${{ github.event.inputs.debug_logs }}" == "true" ]; then
            echo "Initializing Terraform with DEBUG logging..."
            terraform init -no-color 2>&1 | tee init.log
            
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "âŒ Terraform init failed. Showing detailed error log:"
              cat init.log
              exit 1
            fi
          else
            echo "Initializing Terraform..."
            terraform init -no-color
          fi
          
          echo "âœ… Terraform initialized successfully"

      - name: Terraform Validate
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Validating Terraform configuration..."
          
          if [ "${{ github.event.inputs.debug_logs }}" == "true" ]; then
            terraform validate -no-color 2>&1 | tee validate.log
            
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "âŒ Terraform validation failed. Check the log above."
              exit 1
            fi
          else
            terraform validate -no-color
          fi
          
          echo "âœ… Terraform configuration is valid"

      - name: Terraform Plan - Phase 1 (Account & Workspace Resources)
        id: plan_phase1
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Planning Phase 1: Account & Workspace Resources..."
          
          if [ "${{ github.event.inputs.debug_logs }}" == "true" ]; then
            terraform plan \
              -var-file="environments/${{ github.event.inputs.environment || 'dev' }}.tfvars" \
              -out=tfplan-phase1 \
              -lock=true \
              -no-color \
              -target=module.resource_groups \
              -target=module.access_connectors \
              -target=module.workspaces 2>&1 | tee plan-phase1.log
            
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "âŒ Terraform Plan Phase 1 failed. Check the log above."
              cat plan-phase1.log
              exit 1
            fi
          else
            terraform plan \
              -var-file="environments/${{ github.event.inputs.environment || 'dev' }}.tfvars" \
              -out=tfplan-phase1 \
              -lock=true \
              -no-color \
              -target=module.resource_groups \
              -target=module.access_connectors \
              -target=module.workspaces
          fi
          
          echo "âœ… Terraform Plan Phase 1 completed successfully"
        continue-on-error: false

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-phase1
          path: ${{ env.WORKING_DIR }}/tfplan-phase1
          retention-days: 5

      - name: Terraform Apply - Phase 1 (Account & Workspace Resources)
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Applying Phase 1: Account & Workspace Resources..."
          
          if [ "${{ github.event.inputs.debug_logs }}" == "true" ]; then
            terraform apply \
              -auto-approve \
              -lock=true \
              -no-color \
              tfplan-phase1 2>&1 | tee apply-phase1.log
            
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "âŒ Terraform Apply Phase 1 failed. Check the log above."
              cat apply-phase1.log
              exit 1
            fi
          else
            terraform apply \
              -auto-approve \
              -lock=true \
              -no-color \
              tfplan-phase1
          fi
          
          echo "âœ… Terraform Apply Phase 1 completed successfully"

      - name: Get Workspace Information
        id: get_workspace_info
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Retrieving workspace information from Terraform state..."
          
          # Get the workspace URLs from output
          WORKSPACE_URLS=$(terraform output -json workspace_urls 2>/dev/null)
          
          if [ -z "$WORKSPACE_URLS" ] || [ "$WORKSPACE_URLS" == "null" ]; then
            echo "âŒ Error: Could not retrieve workspace URLs from Terraform output"
            echo "Available outputs:"
            terraform output -json
            exit 1
          fi
          
          # Get the first workspace URL from the map
          WORKSPACE_HOST=$(echo "$WORKSPACE_URLS" | jq -r 'to_entries[0].value // empty')
          
          if [ -z "$WORKSPACE_HOST" ]; then
            echo "âŒ Error: Could not extract workspace URL from output"
            exit 1
          fi
          
          # Format as full URL (add https:// if not present)
          if [[ ! "$WORKSPACE_HOST" =~ ^https?:// ]]; then
            WORKSPACE_HOST="https://${WORKSPACE_HOST}"
          fi
      
          echo "âœ… Workspace Information Retrieved:"
          echo "   Host: $WORKSPACE_HOST"
          
          # Update environment variables for subsequent steps
          echo "TF_VAR_databricks_workspace_host=$WORKSPACE_HOST" >> $GITHUB_ENV
          
          # Set outputs for summary
          echo "workspace_host=$WORKSPACE_HOST" >> $GITHUB_OUTPUT

      - name: Terraform Plan - Phase 2 (Workspace-Level Resources)
        id: plan_phase2
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Planning Phase 2: Workspace-Level Resources..."
          
          if [ "${{ github.event.inputs.debug_logs }}" == "true" ]; then
            terraform plan \
              -var-file="environments/${{ github.event.inputs.environment || 'dev' }}.tfvars" \
              -out=tfplan-phase2 \
              -lock=true \
              -no-color \
              -refresh=true 2>&1 | tee plan-phase2.log
            
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "âŒ Terraform Plan Phase 2 failed. Check the log above."
              cat plan-phase2.log
              exit 1
            fi
          else
            terraform plan \
              -var-file="environments/${{ github.event.inputs.environment || 'dev' }}.tfvars" \
              -out=tfplan-phase2 \
              -lock=true \
              -no-color \
              -refresh=true
          fi
          
          echo "âœ… Terraform Plan Phase 2 completed successfully"
        continue-on-error: false

      - name: Upload Plan Artifact - Phase 2
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-phase2
          path: ${{ env.WORKING_DIR }}/tfplan-phase2
          retention-days: 5

      - name: Terraform Apply - Phase 2 (Workspace-Level Resources)
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Applying Phase 2: Workspace-Level Resources..."
          
          if [ "${{ github.event.inputs.debug_logs }}" == "true" ]; then
            terraform apply \
              -auto-approve \
              -lock=true \
              -no-color \
              tfplan-phase2 2>&1 | tee apply-phase2.log
            
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "âŒ Terraform Apply Phase 2 failed. Check the log above."
              cat apply-phase2.log
              exit 1
            fi
          else
            terraform apply \
              -auto-approve \
              -lock=true \
              -no-color \
              tfplan-phase2
          fi
          
          echo "âœ… Terraform Apply Phase 2 completed successfully"

      - name: Terraform Output Summary
        if: success()
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "## ðŸŽ‰ Terraform Deployment Successful âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Version**: ${{ env.TERRAFORM_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Debug Logs**: ${{ github.event.inputs.debug_logs || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ¢ Workspace Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace Host**: ${{ steps.get_workspace_info.outputs.workspace_host }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“¦ Resources Deployed" >> $GITHUB_STEP_SUMMARY
          echo "#### Phase 1 - Account & Workspace Level:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Azure Resource Groups" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Virtual Networks & Subnets" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Storage Accounts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Databricks Workspaces" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Access Connectors" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Unity Catalog Metastores" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### Phase 2 - Workspace Resources:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Storage Credentials" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… External Locations" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Catalogs & Schemas" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Clusters & Cluster Policies" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SQL Warehouses" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Workspace Folders & Permissions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Terraform Outputs" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq '.' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed Summary
        if: failure()
        run: |
          echo "## âŒ Terraform Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the step logs above for detailed error messages" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify all required secrets are configured:" >> $GITHUB_STEP_SUMMARY
          echo "   - AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, AZURE_SUBSCRIPTION_ID, AZURE_TENANT_ID" >> $GITHUB_STEP_SUMMARY
          echo "   - DATABRICKS_ACCOUNT_ID" >> $GITHUB_STEP_SUMMARY
          echo "   - TF_BACKEND_RESOURCE_GROUP, TF_BACKEND_STORAGE_ACCOUNT, TF_BACKEND_CONTAINER" >> $GITHUB_STEP_SUMMARY
          echo "3. Ensure the Service Principal has necessary permissions" >> $GITHUB_STEP_SUMMARY
          echo "4. Check if backend storage account exists and is accessible" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Environment" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Version**: ${{ env.TERRAFORM_VERSION }}" >> $GITHUB_STEP_SUMMARY
